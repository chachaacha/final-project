<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="potato.manager.rest">
	
	<select id="selectRestarea" parameterType="potato.manager.vo.SearchRestVO" resultType="potato.manager.domain.RestDomain">
		select re.restarea_idx, re.name, re.tel,
		   
			( select img
 			  from( select RESTAREA_IDX,AMENITY_TYPE,listagg(icon,',') within group(order by ICON) img
			        from restarea_amenity
			        group by RESTAREA_IDX, AMENITY_TYPE)
 			  where restarea_idx = re.restarea_idx and AMENITY_TYPE='A') retAmImgs,

			( select img
 			  from( select RESTAREA_IDX,AMENITY_TYPE,listagg(icon,',') within group(order by ICON) img
			        from restarea_amenity
			        group by RESTAREA_IDX, AMENITY_TYPE)
              where restarea_idx = re.restarea_idx and AMENITY_TYPE='B') gasAmImgs,

			case when CARWASH_CHK='Y' then 'O'
					 when CARWASH_CHK='N' then 'X'
			     end CARWASH_CHK,
			case when REPAIR_CHK='Y' then 'O'
					 when REPAIR_CHK='N' then 'X'
			     end REPAIR_CHK,
			case when CARGOLOUNGE_CHK='Y' then 'O'
					 when CARGOLOUNGE_CHK='N' then 'X'
			     end CARGOLOUNGE_CHK
		from  restarea re
		<where>
		1=1
		<if test="lineFlag != 0">
		and re.line_idx = #{lineFlag}
		</if>	
		<if test="keyword != null and keyword != ''">
		and re.name like '%'||#{keyword}||'%'
		</if>
		<if test='carwash_chk =="Y"'>
		and re.carwash_chk =#{carwash_chk}
		</if>
		<if test='repair_chk =="Y"'>
		and re.repair_chk =#{repair_chk}
		</if>
		<if test='cargolounge_chk =="Y"'>
		and re.cargolounge_chk =#{cargolounge_chk}
		</if>
		</where>
		order by restarea_idx
		offset (#{pageFlag}-1)*10 rows
		fetch next 10 rows only
	</select> 
	
	<select id="getLine" resultType="potato.manager.domain.LineDomain">
		select line_idx, line
	    from LINE
	    order by line_idx
	</select>
	
	<select id="selectRestTotal" parameterType="potato.manager.vo.SearchRestVO" resultType="int" >
		select count(*) cnt
		from  restarea re
		<where>
		1=1
		<if test="lineFlag != 0">
		and re.line_idx = #{lineFlag}
		</if>	
		<if test="keyword != null and keyword != ''">
		and re.name like '%'||#{keyword}||'%'
		</if>
		<if test='carwash_chk =="Y"'>
		and re.carwash_chk =#{carwash_chk}
		</if>
		<if test='repair_chk =="Y"'>
		and re.repair_chk =#{repair_chk}
		</if>
		<if test='cargolounge_chk =="Y"'>
		and re.cargolounge_chk =#{cargolounge_chk}
		</if>
		</where>
	</select>
	
	<select id="selectRestDetail" parameterType="int" resultType="potato.manager.domain.RestDomain">
		select RESTAREA_IDX,NAME, LNG, LAT,
		       (select line from line where line_idx=ra.line_idx) line, TEL,
		       (select avg(rating) from review where restarea_idx= #{idx}) totalrating,
		       (select count(*) from bookmark where restarea_idx= #{idx}) bookmark_cnt,
		
		       ( select img
		         from( select RESTAREA_IDX,AMENITY_TYPE,listagg(icon,',') within group(order by ICON) img
					   from restarea_amenity
					   group by RESTAREA_IDX, AMENITY_TYPE )
		   	     where restarea_idx = #{idx} and AMENITY_TYPE='A') retAmImgs,
		
			   ( select img
		         from( select RESTAREA_IDX,AMENITY_TYPE,listagg(icon,',') within group(order by ICON) img
					   from restarea_amenity
					   group by RESTAREA_IDX, AMENITY_TYPE)
		         where restarea_idx = #{idx} and AMENITY_TYPE='B') gasAmImgs,
		
			     case when CARWASH_CHK='Y' then 'O'
					      when CARWASH_CHK='N' then 'X'
			          end CARWASH_CHK,
			     case when REPAIR_CHK='Y' then 'O'
					      when REPAIR_CHK='N' then 'X'
			          end REPAIR_CHK,
			     case when CARGOLOUNGE_CHK='Y' then 'O'
					      when CARGOLOUNGE_CHK='N' then 'X'
			          end CARGOLOUNGE_CHK
		
		from restarea ra
		where restarea_idx=#{idx}	
	</select>
	
	<select id="selectFood" parameterType="int" resultType="potato.manager.domain.FoodDomain">
		select FOOD_IDX, MAIN_CHK, REC_CHK, IMG, NAME, PRICE, CONTENTS, INGREDIENT
		from  RESTAREA_FOOD
		where restarea_idx = #{idx}
		order by food_idx	
	</select>
	
	

</mapper>